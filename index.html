<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Live Sensor Data Trend</title>
  <style>
    body { font-family: sans-serif; background-color: #f4f4f9; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
    .chart-container { width: 90%; max-width: 1000px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 8px rgba(0,0,0,0.1); }
    .controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; align-items: center; }
    .controls button, .controls select, .controls input { padding: 8px 12px; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; }
    .controls button.active { background-color: #4CAF50; color: white; border-color: #4CAF50; }
    #tag-toggles label { margin-right: 15px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
</head>
<body>
  <div class="controls">
    <select id="yearFilter"><option value="all">All Years</option></select>
    <select id="monthFilter"><option value="all">All Months</option></select>
    <button id="btn1min" class="active">1 Minute</button>
    <button id="btn5min">5 Minutes</button>
    <button id="btn10min">10 Minutes</button>
  </div>
  <div class="controls">
    <label>From: <input type="time" id="startTimeFilter"/></label>
    <label>To: <input type="time" id="endTimeFilter"/></label>
    <button id="applyTimeFilter">Apply Time</button>
    <button id="clearTimeFilter">Clear</button>
  </div>
  <div class="controls" id="tag-toggles"></div>
  <div class="chart-container">
    <canvas id="myChart"></canvas>
  </div>

  <script>
    const webAppUrl = 'https://script.google.com/macros/s/AKfycbxqqY_fZ8zD73AvWorAADPHtC2ly5XT1TVN47rvsqOWo5BsR5J5RIkrNxeoTiCGFMYqfA/exec';

    const yearFilter = document.getElementById('yearFilter');
    const monthFilter = document.getElementById('monthFilter');
    const tagTogglesContainer = document.getElementById('tag-toggles');
    const startTimeFilter = document.getElementById('startTimeFilter');
    const endTimeFilter = document.getElementById('endTimeFilter');
    const applyTimeFilterBtn = document.getElementById('applyTimeFilter');
    const clearTimeFilterBtn = document.getElementById('clearTimeFilter');
    const chartCanvas = document.getElementById('myChart');

    let rawData = [];
    let myChart;
    let currentInterval = 1;
    const chartColors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];

    async function fetchData() {
      try {
        const response = await fetch(`${webAppUrl}?v=${Date.now()}`);
        const data = await response.json();
        rawData = data.map(row => ({
          x: new Date(row[0].replace(' ', 'T')),
          id: row[1].trim(),
          y: parseFloat(row[2])
        })).filter(d => !isNaN(d.x) && !isNaN(d.y) && d.id);

        rawData.sort((a, b) => a.x - b.x);
        populateYearFilter();
        createTagToggles();
      } catch (err) {
        console.error('Data Fetch Error:', err);
      }
    }

    function processData(data, interval) {
      if (interval === 1) return data;
      const buckets = new Map();
      data.forEach(point => {
        const bucketTime = Math.floor(point.x.getTime() / (interval * 60000)) * (interval * 60000);
        if (!buckets.has(bucketTime)) {
          buckets.set(bucketTime, point); // Simple down-sample
        }
      });
      return [...buckets.values()];
    }

    function populateYearFilter() {
      const years = [...new Set(rawData.map(p => p.x.getFullYear()))];
      yearFilter.innerHTML = '<option value="all">All Years</option>';
      years.forEach(y => {
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y;
        yearFilter.appendChild(opt);
      });
    }

    function createTagToggles() {
      const ids = [...new Set(rawData.map(p => p.id))];
      tagTogglesContainer.innerHTML = '';
      ids.forEach((id, i) => {
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.id = 'tag-' + i;
        input.value = id;
        input.checked = true;
        input.addEventListener('change', renderChart);

        const label = document.createElement('label');
        label.htmlFor = input.id;
        label.textContent = id;

        tagTogglesContainer.appendChild(input);
        tagTogglesContainer.appendChild(label);
      });
    }

   
